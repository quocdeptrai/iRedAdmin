FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    libldap2-dev \
    libsasl2-dev \
    libssl-dev \
    default-libmysqlclient-dev \
    libpq-dev \
    pkg-config \
    nginx \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /opt/iredadmin

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir uwsgi

# Copy application files
COPY . .

# Create uwsgi config
RUN cat > /opt/iredadmin/uwsgi.ini <<EOF
[uwsgi]
chdir = /opt/iredadmin
wsgi-file = iredadmin.py
callable = application
master = true
processes = 4
threads = 2
socket = 127.0.0.1:7791
protocol = uwsgi
buffer-size = 8192
vacuum = true
die-on-term = true
logto = /var/log/iredadmin/uwsgi.log
py-autoreload = 1
EOF

# Create nginx config
RUN cat > /etc/nginx/sites-available/default <<EOF
upstream iredadmin {
    server 127.0.0.1:7791;
}

server {
    listen 80;
    server_name _;
    client_max_body_size 50M;

    location /static/ {
        alias /opt/iredadmin/static/;
        expires 7d;
        access_log off;
    }

    location / {
        include uwsgi_params;
        uwsgi_pass iredadmin;
        uwsgi_read_timeout 300;
    }
}
EOF

# Create supervisor config
RUN cat > /etc/supervisor/conf.d/iredadmin.conf <<EOF
[supervisord]
nodaemon=true
user=root

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/var/log/iredadmin/nginx.log
stdout_logfile_maxbytes=0
stderr_logfile=/var/log/iredadmin/nginx.error.log
stderr_logfile_maxbytes=0

[program:uwsgi]
command=/usr/local/bin/uwsgi --ini /opt/iredadmin/uwsgi.ini
autostart=true
autorestart=true
stdout_logfile=/var/log/iredadmin/uwsgi.stdout.log
stdout_logfile_maxbytes=0
stderr_logfile=/var/log/iredadmin/uwsgi.stderr.log
stderr_logfile_maxbytes=0
EOF

# Create log directory
RUN mkdir -p /var/log/iredadmin

EXPOSE 80

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
